#!/bin/sh

set -e

base=$(readlink -f $(dirname $(readlink -f $0))/..)
cd $base
. $base/lib/environment.sh

if [ "$(whoami)" != root ]; then
  echo "This script must be run as root"
  exit 1
fi

export LANG=C
export LC_ALL=C

# default configuration
concurrency=$(($(nproc) - 1))
if [ "$concurrency" -lt 1 ]; then
  concurrency=1
fi

if [ -r /etc/default/dep8runner ]; then
  . /etc/default/dep8runner
fi


log() {
  logger -t dep8 -i "$@"
}

run() {
  log "Starting setup phase"
  ./scripts/setup > /dev/null
  log "Finished setup phase"

  log "start processing of all packages"
  su "$dep8_user" -c "./scripts/process-all-packages -j $concurrency"
  log "finished processing of all packages"
}


(
  flock -n 9 || exit 0
  run
) 9>/var/lock/dep8.lock

