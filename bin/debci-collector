#!/bin/sh

# Receives test results published to the AMQP queue by debci-worker instances

set -eu

short_options='w'
long_options='write-results'

usage() {
  cat <<EOF
usage: debci-collector [OPTIONS]

$@
EOF
}

debci_base_dir=$(readlink -f $(dirname $(readlink -f $0))/..)
. $debci_base_dir/lib/environment.sh
. $debci_base_dir/lib/functions.sh

write_results() {
  local exitcode=$(tar xzfv - -C "$debci_data_basedir" | grep 'exitcode$')
  local package=$(basename $(dirname $(dirname $exitcode)))
  log "$package results received (exit code: $(cat $debci_data_basedir/$exitcode))"
}

while true; do
  case "$1" in
    --write-results)
      write_results
      exit 0
      ;;
    *)
      break
      ;;
  esac
done

log "I: Connecting to AMQP queue ${debci_amqp_results_queue} on ${debci_amqp_server}"
amqp-declare-queue --url="$debci_amqp_server" --durable --queue="$debci_amqp_results_queue" >/dev/null
exec amqp-consume --url="$debci_amqp_server" --queue="$debci_amqp_results_queue" -- $0 --write-results
