#!/bin/sh

set -eu

usage() {
  cat <<EOF
usage: debci-setup [OPTIONS]

$@
EOF
}
export debci_base_dir=$(readlink -f $(dirname $(readlink -f $0))/..)
. $debci_base_dir/lib/environment.sh
. $debci_base_dir/lib/functions.sh

prepare_args

mkdir -p "$debci_log_dir"
log="$debci_log_dir/debci-setup.log"
if [ ! -f "$log" ]; then
  touch "$log"
  user_group=$(stat -c %U:%G "${debci_log_dir}")
  chown $user_group "$log"
fi

if which create-testbed >/dev/null 2>/dev/null; then
  if [ -t 1 ]; then
    run_with_exclusive_lock "$debci_testbed_lock" create-testbed 2>&1 | tee --append "$log"
  else
    run_with_exclusive_lock "$debci_testbed_lock" create-testbed >>$log 2>&1
  fi
else
  echo "I: $debci_backend backend does not provide a way to create a testbed"
fi
