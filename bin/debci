#!/bin/sh

set -e

if [ -r /etc/default/debci ]; then
  . /etc/default/debci
fi

base=$(readlink -f $(dirname $(readlink -f $0))/..)
cd $base
. lib/environment.sh

# default configuration
concurrency=1

log() {
  logger -t debci -i "$@"
}

run() {
  if type update-testbed >/dev/null 2>/dev/null; then
    log "Updating backend testbed"
    update-testbed
  else
    log "Backend $debci_backend does not provide a way to update testbed!"
  fi
  log "Finished update of backend testbed"

  log "start processing of all packages"
  ./scripts/process-all-packages -j $concurrency CMDLINE="$@"
  log "finished processing of all packages"
}

while true; do
  if [ "$1" = '--' ]; then
    shift
    break
  else
    shift
  fi
done

(
  flock -n 9 || exit 0
  run "$@"
) 9>/var/lock/debci.lock

